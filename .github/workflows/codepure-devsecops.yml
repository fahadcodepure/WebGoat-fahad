name: Codepure DevSecOps Scan

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]
  workflow_dispatch:

jobs:
  codepure_scan:
    name: Run Codepure SAST Scan
    runs-on: self-hosted

    steps:
      - name: Print Git context info
        run: |
          set +x
          echo "ğŸ“ Branch: ${{ github.ref_name }}"
          echo "ğŸ“¦ Commit SHA: ${{ github.sha }}"
          echo "ğŸ‘¤ Actor: ${{ github.actor }}"
          echo "ğŸ•’ Timestamp: $(date)"

      - name: Validate CODEPURE_API_TOKEN secret
        run: |
          set +x
          if [ -z "${{ secrets.CODEPURE_API_TOKEN }}" ]; then
            echo "âŒ CODEPURE_API_TOKEN is missing"
            exit 1
          else
            echo "âœ… CODEPURE_API_TOKEN is available"
          fi

      - name: Trigger DevSecOps scan and capture summary
        id: codepure
        run: |
          set +x
          echo "ğŸš€ Triggering Codepure scan..."
          curl -s -X POST http://100.73.201.73:3000/api/github/devsecops/commit \
            -H "Content-Type: application/json" \
            -H "Authorization: Token ${{ secrets.CODEPURE_API_TOKEN }}" \
            --data-raw "$(jq -n \
              --arg repo_name 'WebGoat-fahad' \
              --arg owner 'fahadcodepure' \
              --arg branch '${{ github.ref_name }}' \
              --arg commit_hash '${{ github.sha }}' \
              --arg project_name 'WebGoat-fahad' \
              --arg language 'java' \
              --arg triggered_by 'github' \
              '{
                repo_name: $repo_name,
                owner: $owner,
                branch: $branch,
                commit_hash: $commit_hash,
                project_name: $project_name,
                language: $language,
                triggered_by: $triggered_by
              }')" > codepure_result.json

          echo "âœ… Codepure response:"
          cat codepure_result.json

      - name: Block if any vulnerabilities found
        run: |
          set +x
          echo "ğŸ” Evaluating scan summary..."

          if ! jq -e '.summary | type == "array"' codepure_result.json > /dev/null; then
            echo "âš ï¸  'summary' field is missing or not an array in response."
            echo "ğŸš¨ Full response:"
            cat codepure_result.json
            exit 1
          fi

          VULN_COUNT=$(jq '[.summary[] | .count] | add' codepure_result.json)
          echo "ğŸ”¢ Total vulnerabilities: $VULN_COUNT"

          if [ "$VULN_COUNT" -gt 0 ]; then
            echo "âŒ Vulnerabilities found. Blocking merge."
            echo "ğŸ”— Visit dashboard:"
            jq -r '.dashboard' codepure_result.json

            echo "ğŸ“Š Vulnerability Summary:"
            jq -r '.summary[] | "â€¢ \(.bug_name): \(.count) [Severity: \(.severity)]"' codepure_result.json

            exit 1
          else
            echo "âœ… No vulnerabilities found. Merge allowed."
          fi
