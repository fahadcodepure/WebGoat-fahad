name: Codepure DevSecOps Scan

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]

jobs:
  codepure_scan:
    name: Run Codepure SAST Scan
    runs-on: ubuntu-latest

    steps:
    - name: Trigger DevSecOps scan in Codepure
      run: |
        echo "üîÅ Triggering DevSecOps scan..."
        curl -s -X POST http://100.73.201.73:3000/api/github/devsecops/commit \
          -H "Content-Type: application/json" \
          -H "Authorization: Token ${{ secrets.CODEPURE_API_TOKEN }}" \
          -d '{
            "repo_name": "WebGoat-fahad",
            "owner": "codepureteam",
            "branch": "${{ github.ref_name }}",
            "commit_hash": "${{ github.sha }}",
            "project_name": "WebGoat-fahad",
            "language": "js",
            "triggered_by": "github"
          }'

    - name: Wait for approval from Codepure
      run: |
        echo "‚è≥ Polling scan status..."
        for i in {1..15}; do
          STATUS=$(curl -s "http://100.73.201.73:3000/api/commitStatus?project_name=WebGoat-fahad&commit_hash=${{ github.sha }}" | jq -r '.status')
          echo "üîé Status: $STATUS"
          if [[ "$STATUS" == "approved" ]]; then
            echo "‚úÖ Approved."
            exit 0
          elif [[ "$STATUS" == "failed" ]]; then
            echo "‚ùå Scan failed due to policy violation."
            exit 1
          fi
          sleep 10
        done
        echo "‚ùå Timeout waiting for approval."
        exit 1
