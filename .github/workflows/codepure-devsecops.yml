name: Codepure DevSecOps Scan

on:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main
      - dev
  workflow_dispatch:

jobs:
  codepure_scan:
    name: Run Codepure SAST Scan
    runs-on: self-hosted

    steps:
      - name: Print Git context info
        run: |
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit SHA: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
          echo "Timestamp: $(date)"

      - name: Validate CODEPURE_API_TOKEN secret
        run: |
          if [ -z "${{ secrets.CODEPURE_API_TOKEN }}" ]; then
            echo "❌ CODEPURE_API_TOKEN is missing"
            exit 1
          else
            echo "✅ CODEPURE_API_TOKEN is available"
          fi

      - name: Trigger DevSecOps scan and capture summary
        id: codepure
        run: |
          echo "Triggering scan..."
          curl -s -X POST http://100.73.201.73:3000/api/github/devsecops/commit \
            -H "Content-Type: application/json" \
            -H "Authorization: Token ${{ secrets.CODEPURE_API_TOKEN }}" \
            --data-raw "$(jq -n \
              --arg repo_name 'WebGoat-fahad' \
              --arg owner 'fahadcodepure' \
              --arg branch '${{ github.ref_name }}' \
              --arg commit_hash '${{ github.sha }}' \
              --arg project_name 'WebGoat-fahad' \
              --arg language 'java' \
              --arg triggered_by 'github' \
              '{
                repo_name: $repo_name,
                owner: $owner,
                branch: $branch,
                commit_hash: $commit_hash,
                project_name: $project_name,
                language: $language,
                triggered_by: $triggered_by
              }')" > codepure_result.json

          cat codepure_result.json

      - name: Block if any vulnerabilities found
        run: |
          echo "Evaluating scan summary..."
          VULN_COUNT=$(jq '[.summary[] | .count] | add' codepure_result.json)
          echo "Total vulnerabilities: $VULN_COUNT"

          if [ "$VULN_COUNT" -gt 0 ]; then
            echo "❌ Vulnerabilities found. Blocking merge."
            jq -r '.dashboard' codepure_result.json
            exit 1
          else
            echo "✅ No vulnerabilities found."
          fi
